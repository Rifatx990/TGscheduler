<!DOCTYPE html>
<html>
<head>
<title>Telegram Dashboard</title>
<style>
body{font-family:Arial,sans-serif;margin:20px}h2{margin-top:30px}input,button{margin:5px;padding:5px}ul{list-style:none;padding:0}li{margin:5px 0}button{cursor:pointer}
.progress-bar{width:0%;height:10px;background:green;margin-top:3px}
</style>
</head>
<body>

<h2>Login</h2>
<input type="text" id="phone" placeholder="Phone">
<input type="text" id="code" placeholder="Code">
<button onclick="login()">Login</button>

<h2>Send Message / Files Now</h2>
<input type="text" id="user" placeholder="Username / Chat ID">
<input type="text" id="message" placeholder="Message">
<input type="file" id="file" multiple>
<div class="progress-bar" id="send_progress"></div>
<button onclick="sendNow()">Send</button>

<h2>Scheduler</h2>
<input type="text" id="sched_user" placeholder="Username / Chat ID">
<input type="text" id="sched_message" placeholder="Message">
<br>
<input type="radio" name="sched_type" value="date" checked> Date
<input type="radio" name="sched_type" value="cron"> Cron
<br>
<input type="datetime-local" id="sched_time">
<input type="text" id="sched_cron" placeholder="Cron string, e.g., 0 10 * * *">
<input type="file" id="sched_file" multiple>
<div class="progress-bar" id="sched_progress"></div>
<br>
<button onclick="addSchedule()">Add Schedule</button>
<button onclick="startScheduler()">Start Scheduler</button>
<button onclick="stopScheduler()">Stop Scheduler</button>

<h3>Current Schedule</h3>
<ul id="schedule_list"></ul>

<script>
async function login(){
  const phone=document.getElementById("phone").value;
  const code=document.getElementById("code").value;
  console.log(await (await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone,code})})).json());
}

async function sendNow(){
  const user=document.getElementById("user").value;
  const message=document.getElementById("message").value;
  const files=document.getElementById("file").files;
  let fd=new FormData(); fd.append("user",user); fd.append("message",message);
  for(let f of files) fd.append("file",f);
  const xhr=new XMLHttpRequest();
  xhr.upload.onprogress=e=>document.getElementById("send_progress").style.width=(e.loaded/e.total*100)+"%";
  xhr.open("POST","/send_now"); xhr.send(fd);
}

async function addSchedule(){
  const type=document.querySelector('input[name="sched_type"]:checked').value;
  const user=document.getElementById("sched_user").value;
  const message=document.getElementById("sched_message").value;
  const files=document.getElementById("sched_file").files;
  let fd=new FormData(); fd.append("type",type); fd.append("user",user); fd.append("message",message);
  for(let f of files) fd.append("file",f);
  if(type=="date") fd.append("timestamp",new Date(document.getElementById("sched_time").value).getTime()/1000);
  else if(type=="cron") fd.append("cron",document.getElementById("sched_cron").value);
  const xhr=new XMLHttpRequest();
  xhr.upload.onprogress=e=>document.getElementById("sched_progress").style.width=(e.loaded/e.total*100)+"%";
  xhr.onload=()=>fetchSchedule();
  xhr.open("POST","/scheduler"); xhr.send(fd);
}

async function startScheduler(){console.log(await (await fetch("/scheduler/start",{method:"POST"})).json());}
async function stopScheduler(){console.log(await (await fetch("/scheduler/stop",{method:"POST"})).json());}

async function fetchSchedule(){
  const data=await (await fetch("/scheduler")).json();
  const list=document.getElementById("schedule_list"); list.innerHTML="";
  data.forEach((item,index)=>{
    let li=document.createElement("li");
    let nextRun="";
    if(item.type=="date") nextRun=new Date(item.timestamp*1000).toLocaleString();
    else if(item.type=="cron") nextRun=new Date(item.next_run*1000).toLocaleString();
    li.textContent=`${index}: ${item.user} - ${item.message} - Type:${item.type} - Next Run: ${nextRun} - Files: ${(item.files||[]).join(", ")}`;
    let delBtn=document.createElement("button"); delBtn.textContent="Delete"; delBtn.onclick=async()=>{await fetch("/scheduler/delete/"+index,{method:"DELETE"}); fetchSchedule();}
    li.appendChild(delBtn); list.appendChild(li);
  });
}

setInterval(fetchSchedule,5000); fetchSchedule();
</script>
</body>
</html>
